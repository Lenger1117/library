{% extends "base.html" %}

{% block title %} {{ book.name }} {% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <!-- Левая колонка: Изображение книги -->
    <div class="col-md-3">
      {% if book.image %}
        <img src="{{ book.image.url }}" class="img-thumbnail w-100">
      {% else %}
        <p>Изображение не загружено</p>
      {% endif %}
    </div>

    <!-- Средняя колонка: Информация о книге -->
    <div class="col-md-6">
      <h5 class="card-title">{{ book.name }}</h5>

      <!-- Авторы -->
      <p class="card-text">
        <b>Автор:</b>
        {% if book.authors.count == 1 %}
          <a href="#">{{ book.authors.first.name }}</a>
        {% else %}
          <span class="author-tooltip">
            <a href="#">{{ book.authors.first.name }}</a> и др.
            <span class="tooltip-text">
              {% for author in book.authors.all %}
                {{ author.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </span>
          </span>
        {% endif %}
      </p>

      <!-- Жанры -->
      <p class="card-text">
        <b>Жанры:</b>
        {% for genre in book.genres.all %}
          <a href="{% url 'books:genre' genre.slug %}" class="text-decoration-none text-dark">{{ genre }}</a>{% if not forloop.last %}, {% endif %}
        {% empty %}
          Нет жанров
        {% endfor %}
      </p>

      <!-- Рейтинг и количество отзывов -->
      <p class="card-text">
        <i class="fas fa-star text-warning"></i>
        {% if book.average_rating > 0 %}
          {{ book.average_rating }}
        {% else %}
          Нет оценок
        {% endif %}
        (<a href="#reviews" class="text-decoration-none text-dark">{{ book.review_count }} отзыв{{ book.review_count|pluralize:"ов" }}</a>)
      </p>

      <!-- О книге -->
      <p><b>О книге:</b></p>
      <p>{{ book.description|linebreaks }}</p>

      <!-- Отзывы -->
      <div id="reviews" class="mt-4">
        <h4>Отзывы</h4>
        {% if book.reviews.exists %}
          <ul class="list-group">
            {% for review in book.reviews.all %}
              <li class="list-group-item">
                <p><b>{{ review.user.first_name }}</b> ({{ review.created_at|date:"d.m.Y" }}):</p>
                <p>Оценка: {{ review.rating }}</p>
                <p>{{ review.comment|default:"Без комментария" }}</p>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>Пока нет отзывов.</p>
        {% endif %}
      </div>

      <!-- Форма добавления отзыва -->
      {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'books:add_review' book.slug %}" class="mt-3">
          {% csrf_token %}
          <div class="mb-3">
            <label for="id_rating" class="form-label">Оценка</label>
            <select name="rating" id="id_rating" class="form-select">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="id_comment" class="form-label">Отзыв</label>
            <textarea name="comment" id="id_comment" class="form-control" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Оставить отзыв</button>
        </form>
      {% else %}
        <p class="text-muted small">
          Чтобы оставить отзыв, пожалуйста,
          <a href="{% url 'users:login' %}">войдите в аккаунт</a>
          или <a href="{% url 'users:register' %}">зарегистрируйтесь</a>.
        </p>
      {% endif %}
    </div>

    <!-- Правая колонка: Кнопки -->
<div class="col-md-3">
  <div class="text-center mt-4"> <!-- Добавляем отступ сверху и выравнивание по центру -->
    <!-- Кнопка "Добавить в избранное" или "Удалить из избранного" -->
    <form method="post" action="{% url 'books:favorite' book.slug %}" class="d-inline mb-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary w-75"> <!-- Уменьшаем ширину кнопки -->
        <i class="fas fa-heart {% if is_favorite %}text-danger{% else %}text-secondary{% endif %}"></i>
        {% if is_favorite %}
          Удалить из избранного
        {% else %}
          Добавить в избранное
        {% endif %}
      </button>
    </form>

    <!-- Кнопка "Редактировать книгу" для суперпользователя -->
    {% if request.user.is_superuser %}
      <a href="{% url 'books:edit_book' book.slug %}" class="btn btn-outline-secondary w-75 mt-3">
        Редактировать
      </a>
    {% endif %}
  </div>
</div>

<!-- Отображение сообщений -->
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}
{% endblock content %}